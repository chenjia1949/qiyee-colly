package main

import (
	"encoding/csv"
	"fmt"
	"io"
	"io/ioutil"
	"log"
	"net/http"
	"net/http/cookiejar"
	"os"
	"time"

	"github.com/tidwall/gjson"
)

// const fileName = "/home/meng/文档/myshare/colly/olx/record_test.csv"

var fileName = fmt.Sprintf("olx_%s.csv", time.Now().Format("20060102"))

// 获取手机号链接
var _phoneUrl = "https://www.olx.co.id/api/users/%s"

var id = 16

func getPhone(ch chan []string) {
	f, err := os.Open(fileName)
	if err != nil {
		panic(err)
	}
	defer f.Close()
	r := csv.NewReader(f)
	i := 0
	for {
		i++
		row, err := r.Read()
		if err != nil {
			if err == io.EOF {
				break
			}
			fmt.Printf("read row error:%v\n", err)
		}
		if i < 2 {
			continue
		}
		// if len(row) == 19 {
		row = append(row, reqPhone(row[16]))
		// }
		ch <- row
	}
}

var gCurCookieJar *cookiejar.Jar

func init() {
	//var err error;
	gCurCookieJar, _ = cookiejar.New(nil)

}

var first bool

// var cookie = `locationPath=[{"id":4000030,"name":"Jakarta Selatan","type":"CITY","longitude":106.80105,"latitude":-6.2609,"parentId":2000007}]; laquesis=pan-59312@a#pan-59740@a#pan-60601@b#pan-67471@b; lqstatus=1658195958; G_ENABLED_IDPS=google; user=j:{"id":"122507225","name":"wang test"}; lf=1; t=eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCIsImtpZCI6ImViT21QTmlrIn0.eyJncmFudFR5cGUiOiJncGx1cyIsImNsaWVudFR5cGUiOiJ3ZWIiLCJ0b2tlblR5cGUiOiJhY2Nlc3NUb2tlbiIsImlzTmV3VXNlciI6ZmFsc2UsImlhdCI6MTY1OTUxMDM0MSwiZXhwIjoxNjU5NTExMjQxLCJhdWQiOiJvbHhpZCIsImlzcyI6Im9seCIsInN1YiI6IjEyMjUwNzIyNSIsImp0aSI6IjRjZjQzMjI4ZjY3OTkwMTQ2YmU3MGVjYWMyMDgzNDdhMzYzNmMyMGYifQ.c28Ls8MqcLfxoQZD4SpfzqM-zczRpWuaXuNVkWRo5QzhuE6lucHGHJwPuZQ2O_hu5cdyxDBDHU8a_4yXWAaoviP4QfIoGZRhRi-x8zmDF8PeU2sezaXLs3rbokFDfYmndNVt8fkuPbcOC4MCSvp1qNrwUvOf-CQD3JjsQ8Z84NXB4UgQUOuKKmVofXbw7qxDwWjAoSvhGubqji36rXdn7Dlv_s1GAW_IgjBnrhsqYTApGTAu8WLJzFI9MNMbTfolTztx_QNN0GEgnEWsQTca6Qtft1BMWmU-K6bdrsApbIPDAfOfmeptkpbCmQfS4zLivb-XAX0lkdkO6umxx9duIw; rt=eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCIsImtpZCI6ImViT21QTmlrIn0.eyJncmFudFR5cGUiOiJncGx1cyIsImNsaWVudFR5cGUiOiJ3ZWIiLCJ0b2tlblR5cGUiOiJyZWZyZXNoVG9rZW4iLCJyZWFjdGl2YXRlZCI6ZmFsc2UsImlhdCI6MTY1OTUxMDM0MSwiZXhwIjoxNjY3NTQ1NTQxLCJhdWQiOiJvbHhpZCIsImlzcyI6Im9seCIsInN1YiI6IjEyMjUwNzIyNSIsImp0aSI6IjRjZjQzMjI4ZjY3OTkwMTQ2YmU3MGVjYWMyMDgzNDdhMzYzNmMyMGYifQ.Pgf03cbF5CnmW0WCw6KZ4hnVE2bbwK_GZBoErkR3TNhs7y4SQDT7cdP7Gg-oFa0IKTpKhGxAg61AtmJF96YAehQUlhe_vSH_ffted4vWs2UIt6fCg8BSycG3KhWQ9sqYBuADpBq9alv-oV56hmD6hz-KVRm55RzWLypOg13DHPugJjPJn2hI8ZtVoraj9jv36IWXE51EQJbqRLIAtaymxCS7-9b6eTbRY4CyZm8UclsNWAAuDvX-yweu_3HUzOeZ4feRCMh_cwq1OPeLeAhqTiBI_DWO1Bh6Vjhb7t-hTl9JzhmXTFK7T6-ekc_Dkt7KtiXjWo5LKfC7TxowwvAJvQ; ct=eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCIsImtpZCI6ImViT21QTmlrIn0.eyJ0b2tlblR5cGUiOiJjaGF0VG9rZW4iLCJ2ZXJzaW9uIjoiMSIsImlhdCI6MTY1OTUxMDM0MSwiZXhwIjoxNjU5NTk2NzQxLCJhdWQiOiJvbHhpZCIsImlzcyI6Im9seCIsInN1YiI6IjEyMjUwNzIyNSIsImp0aSI6IjRjZjQzMjI4ZjY3OTkwMTQ2YmU3MGVjYWMyMDgzNDdhMzYzNmMyMGYifQ.RTNAUDALg8QRuV9V64nxlugZyPVAI3Ef56BytlakfXK1lSz49qmACYTBFL3IvOgxJpAoaIvCA_o6RBiNxBVOkdCLZ0MafmSnqpa6FdThUjg4cNFb17rbtMTdr4LwZoso-XkN5fDFAG74RQjU8V_R7lqWfyhnOSsU0tC6MJXVifIR8lc-qGAJbxVTPWFwWZeAOHkpS_U_tleO9LGrt1CJEBkbArpl_4s9iHVpb32egjzBr_qGQOr2Xa0x1PGwbXgxHOo9xlArSeTmoC9YJMbPeGPbg193j6QtJ6uD1RXcr5Ro-oa3IP1iVnlMk9iXX5T5PVuNivzoeuVpC2WIfvKBbQ; nt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE2NTk1MTAzNDEsImJyYW5kIjoib2x4IiwiY291bnRyeUNvZGUiOiJpZCIsInVzZXJJZCI6MTIyNTA3MjI1fQ.xq1ACc209E9-udvs-vZbo1hwZgGLkQ2eg6dSiIcnGGo; _abck=EBED42F344620BC816C09B5808A2C2E3~0~YAAQz/xkX57kkVuCAQAAi0iGYghWiwdi/QKClwE82Sw69lNjP5pS/K+GwIhltfuSdPAF6Q+LdDaezVDcgvZZ5vAB/JBOID/cqkAce5H03NPFMHpRAfRUp65n2Kloo4Dw7A8vbaLFq5pkirH+KymcNRGmJhsaOpb1+y2ztXLNITNvTY7o4YiaKQBOY7rv7AbA3fdo13oP2MwW3ZhofHe/l5Cin/QoyGYvlfu6R+ls23MhdSWJH0nopzsUUqMtNtrNFBaEY7k3xcSyoHjjr5Dl9rtec/05Kbw+a7zciXSCT6F2BIYm7OMTR1mLkpwZ0VhvVEBCFx+fp/9oq1AlL6QpgY+e1evGo2q3F0kjtPmWsC2zFWrOjYRT/DawD63tHKV1i+g02OZi2i72hox+1WFKc1dI9dXi5A==~-1~-1~-1; ak_bmsc=FC8FC81A57B85E8333409AA2D01A3C39~000000000000000000000000000000~YAAQz/xkX5/kkVuCAQAAi0iGYhAP+u34QWa2e3p+rxFd7J5wiOkVv/2g57e3jdhOwef1lAL/zxTffK06eM+qFKyeojOjY+x/VYkJ2Gv+OzPRN81lGOc7Rm0u67IDwNQ+dSu48Sm3ickPvKK4UnmCdHEWueU9+JxbBnjHKVTpGwCJsf+ytRSBvy82GCq/IJZXHOLqoXB1Gqp8LCFbyWeRiGMiIzNLa1/AQqdUp75PKXtscYEB3OGGkUbiW/rFxovuk9G9zSmhtFpyrZjD+ZVjEr608Djg6TSX7bJXzh3pxWIkT3FG3/c+6ffWOyHgEq7dIGJX+8Os2IKAoruMMijkNyqg9gqD58m5zP/zE0C6Peskjk8k0xKfq6ImR6XTkvnLbd3y63n4dH6ENu0=; bm_sz=F13EDCB9E5A1C82DC8700376DDC738F8~YAAQz/xkX6HkkVuCAQAAi0iGYhDJLLKSXFGC8Dp2f1N3V0/IczqnWFBiDqaatDasSrcxyNBdaw6ndIrL8CjFlS1h8J1/ZrP7Kk7dKoHNYDpBMbIS/VAMrRY6/742igPFLfTi1zWyZuMDPXjRAmvJsbuDZoXtN9/NqLTSd32xhreZi6oyKqk5vZS5rbrq4athmSg2pVGT9MuCUgLkjDrWltdwHvfQR0gkzLetmp3ix8FJSECeguvee1EjKeVEPYK9cjqOOSq63v5J9MSwrKWL76ehwYoxVnPIEIYXFQCew2IGZA==~3555640~4404547; reply_restriction=false; kyc_reply_count=0; bm_mi=B6E0FFA90C90E9810757676FCC9BE801~YAAQz/xkX3TokVuCAQAA+syGYhAHlcRTxvhL2bjNT+TwQ1tQgOBSAAoZmSu+60+0qb4SRYa7yd2yey8GYgfPMZbPDUa5iiKh1sWNNiBqSy1No13EIQa10AjAiy9XnMUysmQy7aSIu3DN0/L+NBkFFpKj3/GPFDRQ8YuWM2OZORMQ7t/WTJ2i+N7HliQ8W1n5nLVcnmZRptGuWxOMWFoEQ04M2ZSOF8Csw8bdZxns+lMCfW/rw818kRtR+UfpgT06xq7SX1IuKai8PVCKzUXcO4L3IKwlZf9Y7vw54YtsYc4lmPVJuzHDSAnp4r9aQgBBwb4IgkFl8nEHTWRwOza9HGRNGS4uGlUBv0rVmMcrPkCM2EeILshy9e5gIl9M~1; bm_sv=583598E7CFEBB368A5BB2D6A9AED3E7B~YAAQz/xkX5LskVuCAQAA4vyGYhC3ntEQIR7ex6LV/yyvE9HPOuMAZm8CdFFgjM0VpshUdGUhTqkjUI/dE5LVmNw07lsNxBKRpdx+rtlnj+etN8YB/Y1jhJWoL8YlAREu0q7t9MJLoyDMBfd8M52TXJztUxIF1/JsjtoDDSjGxPgNtWA1XEW14nsP76D6XSroKIWcYx30FFHTNDzzFMDqhUHV4s8Cq5cj/fC04gTC4xFmj8HTfISa952Z9iSEZje2~1`
var cookie = `laquesis=pan-59312@a#pan-59740@a#pan-60601@b#pan-67471@b; bm_sz=E1A2881641AB5476F76CC2DF8EE51487~YAAQd3pAF5MWL2eCAQAAitVdfBDLpNcmhmft00AwUE4EHU7Vbb212CblsLr7nFlibkJ2dcMrZEl+QlwEn2JdXEU9AqLIYMRCJJ+zf058CWHGh/LStn7ekJyj52h5XR4x7dhd1YlNMqtekzFA4inNKhB8Q6sveT+Z8uO2JC9OJ6rHz1oeUjwgB52Yv+LCDN/I5ZmjKxBHJxDQYVN0bcjibBhltrbGW43bCQhcqplP4CT65GpG9qa+a57V0ECpf5b997G48JhAHUCUn61nyiTZlkMart0QnpL8UjL0aGwvsO65xw==~3424564~3158595; ldTd=true; g_state={"i_l":0}; user=j:{"id":"122810168","name":"jia chen"}; lf=1; reply_restriction=false; kyc_reply_count=0; G_ENABLED_IDPS=google; G_AUTHUSER_H=0; bm_mi=A078CEDAD557876189FFD5F5B7F90CE1~YAAQ4F8yuGMYXF2CAQAANqdjfBCSCaTf31vNOhI1shNMtqu+AdSDj9+McF5MgL75aao/0tSf/BN9i8e8KZ0GL8xKB39EMOtAMVvpt1XiAjhKCJeULpZI0V2kCOfMLt5FiDhoWhL5CEv3yV8j25B3hyVk7RAsL6rzi5Yqr9hMbX4InajzoGLurOHrUDtEwaOTXuTOR/H/7MCFWjvDsrbSe+/MLVDwt1CSA7Js365NmqHlc12cbhpnUOnMI9FE5ZJNzT3cKjRF4VKKUiKTQHdaQ9rdWpcaXWALGIvebLY4WpaMgnfesRzAGoAsTW5FhEDCn1SjuKpgT0gccWGbbQ20G7W4hYrseJYxGyfzdkU8Ziq6SVrdZ/H8yj4ydfutbdp7NSkaA7hdkDqRPqAx57N6hyeHZwmk1nTecK+3Vjes~1; bm_sv=E28268EFE06A53521085F8D63E6465AF~YAAQ4F8yuGUZXF2CAQAAqrJjfBB39BeLgC2W6HKoS7t42Lgox963mN35kTgdm9YNzy/8VTO4sYEY3eqgaw2WTCzuPiWj8HKQMuBQAYkiTzjbN00srlkHXX7pdzM10wJuCG5EkyQ/506iEARU8UUzcEEUt3gnl0MXs/xgB3/36k5xbR+oGU9MYrPKnWyHJgPt0WWli+r6rLlV+FpeY/jSZJX5y70DXnfHlfRx7dTtnhbx1F2AvuymQGM23qYh6UN5~1; ak_bmsc=C1064EF4981746F630A2331C47CD0704~000000000000000000000000000000~YAAQ4F8yuOQlXF2CAQAAmDJkfBB1dPO/PMbwTQt2p4za7/MStdu5rxdNaE7sJl+LDXuf15RblvUQA5DiOHQFLMt8F20TAhJIfwLrn4SwCKhTF/nKd28vBoCQX3KnjvqJhQ0+iD8xuDtmAMN3XuK0UnmWxi7G33HSCda0nQMVTgvghx4ChlT6PNQBwV+BEj4Ya7v3sNZoM+x1w47HgSLrMd9xL9vD9eIkj/pSnM7NHMwbs9hpZB7PS4djm0ZkCWGkfezXcGixvJSS0Nm/eaPUE5HN4K/4rfwrgWZRyaa8aG+ikzFpxJjskrOvgAWaR3MVIm2Y1CwPLAWutMojimXO9314imP5ADJilIxyvVcslsYW8Etnq53qHM9ev+qiNLKyye+uSII487WG2iaR4korT05ZV9Gsy09SfjeXTzMGJO02tSeQYGOmZO2sPBn9eWiSF1YYL/GMGRY5JquYJfTFqLA/z7jYG4dupTGCKPm1c0Ln/HtVJNXr1yM3gfry2bEJ6T+bI1ZGTncyh6Cieh6sDg==; lqstatus=1659946302|1827c5dd4efx7460b98|pan-60601||; laquesisff=; laquesissu=; t=eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCIsImtpZCI6ImViT21QTmlrIn0.eyJncmFudFR5cGUiOiJncGx1cyIsImNsaWVudFR5cGUiOiJ3ZWIiLCJ0b2tlblR5cGUiOiJhY2Nlc3NUb2tlbiIsImlzTmV3VXNlciI6ZmFsc2UsImlhdCI6MTY1OTk0NTc3MCwiZXhwIjoxNjU5OTQ2NjcwLCJhdWQiOiJvbHhpZCIsImlzcyI6Im9seCIsInN1YiI6IjEyMjgxMDE2OCIsImp0aSI6ImE4YmJhYWNlMGM4NjNlNWViZmUxYjg5YjYyOTg4OTMwNjVhOTI4ZDYifQ.OayQ_3pJaBtSK_AFRPChgOyWDmVfZ0_tvzs1pQLWWotxBrtzbJPCFjMmaDlSaiPFemdpRin4NdoBON-BUoMs2TJi1YXzKeH9lBZ6M7LoA1UbCxlHzd1jqzzH8JAy6E6ILbVIt-Y4euf4RfC4w3HY9UsL7ylC30fOp9JT0VMx9jkuhAmkeFFmSm4vkc-76InjNgg8erhmH5fVp1Tcqga4VFbG2bJMc8780UMy03GJ-PIiHKHjL2GMiVcDFqn65W3QTHFRpw-1SCeH1dwJ-OitKXjjgGY6kyv0obe47XHizCX48N5WOSR24svT2DmI8SlzzQLj5dsGj0yDt79MAnBObQ; rt=eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCIsImtpZCI6ImViT21QTmlrIn0.eyJncmFudFR5cGUiOiJncGx1cyIsImNsaWVudFR5cGUiOiJ3ZWIiLCJ0b2tlblR5cGUiOiJyZWZyZXNoVG9rZW4iLCJyZWFjdGl2YXRlZCI6ZmFsc2UsImlhdCI6MTY1OTk0NTc3MCwiZXhwIjoxNjY3OTgwOTcwLCJhdWQiOiJvbHhpZCIsImlzcyI6Im9seCIsInN1YiI6IjEyMjgxMDE2OCIsImp0aSI6ImE4YmJhYWNlMGM4NjNlNWViZmUxYjg5YjYyOTg4OTMwNjVhOTI4ZDYifQ.KYTL5kt3D8kT5BIyuzb31f7qazc25Uytfr01I41YbcfQgwE9clhhGqiRWMYoOT1qPtl-5INPTwcHp2yOBZV9MMH2H7aYziUUg2gC4uvZWvRJ8CKRunJNTHgA-RzDjReRWkhLQsPSZMnSqKLfAEBcGNffeJSMQYEEk5ELz2DFDkyPclBpTMlJSkjjPkSRwmPcscXb6Zm3mWzw-MDYmBCqbRe8n-ltz9cKUGVK8hECJsxCvlPOJAjQsve4HjhiPCfMRyrNYlqswZyJX3CXdDXN4URRig2Ikd1u7R6uTRVAOoYbMJ5XQ-fAn1yq4g119AELhpQ7tGrAmcHMXn2fTRS_dg; ct=eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCIsImtpZCI6ImViT21QTmlrIn0.eyJ0b2tlblR5cGUiOiJjaGF0VG9rZW4iLCJ2ZXJzaW9uIjoiMSIsImlhdCI6MTY1OTk0NTc3MCwiZXhwIjoxNjYwMDMyMTcwLCJhdWQiOiJvbHhpZCIsImlzcyI6Im9seCIsInN1YiI6IjEyMjgxMDE2OCIsImp0aSI6ImE4YmJhYWNlMGM4NjNlNWViZmUxYjg5YjYyOTg4OTMwNjVhOTI4ZDYifQ.gBs0KnNfEuEwL7oUZPkxy2QgeWap6Kudi9pW-fWXlEehgv-ORPwV9eTgwGmBy5GumvZ8CUUxZ6CgMFaxoY2ZTzaZLCGkWLejZjG7NDFIHyCL9Te4gllW4_MI521mI8sk56trdA38pzUu_aSntMQ6J2LJFmDgiaprEhZAmFet-sMYZMx7Fphe0BzWbea--2cqY6ybaVdIJlYOzoXqJ5Ur3stDwukxh9NbB_aTiAb6fkeqzDYwGrYDezcqLVtNmR4cOXQVikbwRvIPXq3POj5Kur08DkknMb0do695Vq1vMzmf8CBXn19uFki25w4n0a3aIido5csOmK4DuRFvR28oRw; nt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE2NTk5NDU3NzAsImJyYW5kIjoib2x4IiwiY291bnRyeUNvZGUiOiJpZCIsInVzZXJJZCI6MTIyODEwMTY4fQ.vT_1fT0yIeijTlmXR841oNCQAAkFbTWA3YnRzWEJ90A; _abck=5EC673EA416F8FC15E4B0D51E3C82362~0~YAAQd3pAF4UgNWeCAQAApl96fAjZRJWGra6vyIVneBhDJ3jUPmQ57OBTwJYpKwB/G4B5N2o504+5pkAdyMfCq5prWydHxWiLATCD99eTvngL6+0lY1dtbf86lXBzJpRs8dYeqIQ3RvXCivSlmDyVV+MXRpfjk7yE38TfpNZybATQNZ1tZq8zRtSAp98GnVR+PvWhItnbAexjHIuRFZWS6Bf1NxHDw7aZiB7d0/fPV7WQKXK2/g0pWV+ZhHPeAG5dhxrDEV/BgdAAPhAHPLIRsa6cFHOzhAPwlXzaM/Q7kGdSwM6YIa7hsqNF1xqFyQ95TO1h1P5fbAnQIcAWz9Khf7E4FJmbImuQhwqOYKBISM11zCKEZolLa83pNNiW8n044EVlJNMWlaOWClAHmH4z+wmicZdua68=~-1~-1~-1; onap=1827c5dd4efx7460b98-1-1827c5dd4efx7460b98-77-1659947591`

func reqPhone(userID string) string {
	client := http.Client{Timeout: time.Second * 20}
	req, err := http.NewRequest("GET", fmt.Sprintf(_phoneUrl, userID), nil) //GET大写

	req.Header.Set("cookie", cookie)
	// req.Header.Set("cookie", os.Getenv("OLX_COOKIE"))

	if err != nil {
		log.Printf("req header err:%+v\n", err)
		return ""
	}
	resp, err := client.Do(req)
	if err != nil {
		log.Printf("req header err:%+v\n", err)
		return ""
	}
	data, err := ioutil.ReadAll(resp.Body)
	resp.Body.Close()
	if err != nil {
		log.Printf("resp read err:%+v\n", err)
		return ""
	}

	//全局保存
	fmt.Printf("data:%s\n", data)
	if resp.StatusCode == http.StatusUnauthorized {
		time.Sleep(time.Second * 3)
		panic(err)
	}
	// 提取手机号
	return gjson.Get(string(data), "data.phone").String()
}
